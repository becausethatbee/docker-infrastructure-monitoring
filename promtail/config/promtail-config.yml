server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Системные логи
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          host: learning-host
          __path__: /var/log/*.log

  # Логи Docker контейнеров с парсингом
  - job_name: containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'compose_project'
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'compose_service'
    pipeline_stages:
      - docker: {}
      
      # HAProxy парсинг
      - match:
          selector: '{container="haproxy"}'
          stages:
            - regex:
                expression: '^(?P<client_ip>[\d\.]+):(?P<client_port>\d+) \[(?P<timestamp>[^\]]+)\] (?P<frontend>\S+) (?P<backend>\S+)/(?P<server>\S+) (?P<tq>-?\d+)/(?P<tw>-?\d+)/(?P<tt>-?\d+) (?P<bytes>\d+)'
            - labels:
                frontend:
                backend:
                server:
      
      # Xray парсинг
      - match:
          selector: '{container="xray"}'
          stages:
            - regex:
                expression: 'from (?P<source_ip>[\d\.]+):(?P<source_port>\d+) (?P<action>\w+) (?P<protocol>\w+):(?P<destination>[^\s]+).* email: (?P<email>[^\s]+)'
            - labels:
                action:
                protocol:
                email:
      
      # Nginx парсинг
      - match:
          selector: '{container="bot-webapp-nginx"}'
          stages:
            - regex:
                expression: '^(?P<remote_addr>[\d\.]+) - - \[(?P<time_local>[^\]]+)\] "(?P<request>[^"]*)" (?P<status>\d+) (?P<body_bytes_sent>\d+)'
            - labels:
                status:
                remote_addr:
      
      - static_labels:
          job: docker

  # Security логи (journald)
  - job_name: security
    journal:
      json: false
      max_age: 12h
      path: /var/log/journal
      labels:
        job: security
        host: learning-host
    pipeline_stages:
      - match:
          selector: '{job="security"}'
          stages:
            - regex:
                expression: '(?P<message>.*)'
            - labels:
                message:
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        target_label: 'unit'
      - source_labels: ['__journal_syslog_identifier']
        target_label: 'syslog_identifier'

  # Системные критичные события
  - job_name: system_critical
    static_configs:
      - targets:
          - localhost
        labels:
          job: system_critical
          host: learning-host
          __path__: /var/log/messages
    pipeline_stages:
      - match:
          selector: '{job="system_critical"} |~ "error|fail|critical|alert"'
          stages:
            - regex:
                expression: '(?P<level>error|fail|critical|alert)'
            - labels:
                level:
